<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Your Beautician | Maison De FFM</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: url("assets/background/bg1.png") center/cover fixed;
            color: white;
            min-height: 100vh;
            padding: 120px 20px 60px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .tracker-container {
            max-width: 720px;
            margin: 0 auto;
            background: rgba(131, 58, 112, 0.75);
            backdrop-filter: blur(22px);
            border-radius: 30px;
            padding: 60px 50px;
            text-align: center;
            border: 2px solid rgba(255, 220, 90, 0.35);
            box-shadow: 0 30px 80px rgba(0,0,0,0.6), 0 0 60px rgba(255,220,90,0.25);
        }
        h1 {
            font-size: 52px;
            color: #ffdc5a;
            letter-spacing: 8px;
            margin-bottom: 15px;
            text-shadow: 0 0 35px rgba(255,220,90,0.9);
        }
        .message {
            font-size: 24px;
            color: #ffd6e8;
            line-height: 1.7;
            margin: 30px 0;
            font-style: italic;
        }
        .info-box {
            background: rgba(255,255,255,0.08);
            padding: 25px;
            border-radius: 20px;
            margin: 30px 0;
            border: 1px solid rgba(255,220,90,0.4);
        }
        .info-box p {
            margin: 12px 0;
            font-size: 19px;
        }
        #status { font-size: 23px; min-height: 70px; margin: 25px 0; }
        #map {
            width: 100%;
            height: 460px;
            border-radius: 24px;
            margin-top: 35px;
            border: 4px solid rgba(255,220,90,0.5);
            box-shadow: 0 0 40px rgba(255,220,90,0.4);
            display: none;
        }
        .btn {
            padding: 20px 60px;
            background: linear-gradient(135deg, #ffdc5a, #f5c147);
            color: #2a0033;
            border: none;
            border-radius: 60px;
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 5px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 12px 50px rgba(255,220,90,0.6);
            transition: all 0.5s;
        }
        .btn:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 70px rgba(255,220,90,0.8);
        }
        .too-early {
            background: rgba(255,100,100,0.15);
            padding: 30px;
            border-radius: 20px;
            border: 1px dashed #ffdc5a;
            margin: 30px 0;
        }
    </style>
</head>
<body>

<div class="tracker-container" id="main-container">
    <h1>TRACK YOUR BEAUTICIAN</h1>

    <div id="too-early-message" style="display:none;">
        <div class="too-early">
            <p>Your appointment is scheduled for</p>
            <h2 id="future-date"></h2>
            <p>Your live tracking will be available <strong>on the day of your appointment only</strong>.</p>
            <p>We’ll send you a reminder 2 hours before!</p>
            <br>
            <button class="btn" onclick="location.href='home.html'">BACK TO HOME</button>
        </div>
    </div>

    <div id="tracking-section">
        <p class="message">Your beautician is preparing to bring luxury to your door</p>

        <div class="info-box">
            <p><strong>Beautician:</strong> <span id="beautician-name">—</span></p>
            <p><strong>Appointment:</strong> <span id="appointment-time">—</span></p>
            <p><strong>Estimated Arrival:</strong> <span id="eta">Calculating...</span></p>
            <p><strong>Status:</strong> <span id="status">Getting ready...</span>
        </div>

        <iframe id="map" loading="lazy"></iframe>

        <button class="btn" id="startTracking">START LIVE TRACKING</button>
    </div>
</div>

<script>
// ======== 1. LOAD BOOKING DATA ===
const booking = JSON.parse(localStorage.getItem("bookingData"));
if (!booking) {
    document.body.innerHTML = `<div style="text-align:center;padding:200px;color:#ffdc5a;font-size:28px;">
        No active booking found.<br><br>
        <a href="booking.html" style="color:#ffdc5a;">← Book Your Session</a>
    </div>`;
}

// ==== 2. CHECK IF TODAY IS THE APPOINTMENT DAY =======
const today = new Date();
const apptDate = new Date(booking.date); // format: YYYY-MM-DD

const isToday = today.toISOString().slice(0,10) === booking.date;

if (!isToday) {
    document.getElementById("too-early-message").style.display = "block";
    document.getElementById("tracking-section").style.display = "none";
    document.getElementById("future-date").textContent = 
        new Date(booking.date).toLocaleDateString('en-US', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        }) + " at " + booking.time;
} else {
    // ========= TODAY → SHOW TRACKING ===
    document.getElementById("beautician-name").textContent = booking.beautician + " ★";
    document.getElementById("appointment-time").textContent = booking.date + " • " + booking.time;

    // Beautician starting locations
    const startLocations = {
        "Anna": [14.6091, 120.9892], "Marie": [14.5547, 121.0244], "Jessa": [14.5794, 121.0359],
        "Clara": [14.6524, 121.0502], "Sophia": [14.5480, 121.0540], "Rica": [14.5995, 120.9842],
        "Ella": [14.6760, 121.0437], "Leo": [14.6253, 121.0321], "Marco": [14.5589, 121.0200]
    };

    let currentLat = startLocations[booking.beautician][0];
    let currentLng = startLocations[booking.beautician][1];
    let destinationLat, destinationLng;

    async function geocodeAndTrack() {
        document.getElementById("status").textContent = "Locating your address...";
        
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(booking.address + ", Metro Manila, Philippines")}`);
        const data = await response.json();

        if (data && data[0]) {
            destinationLat = parseFloat(data[0].lat);
            destinationLng = parseFloat(data[0].lon);
        } else {
            destinationLat = 14.5995; destinationLng = 120.9842; // fallback
        }

        document.getElementById("map").style.display = "block";
        document.getElementById("startTracking").style.display = "none";
        document.getElementById("status").textContent = `${booking.beautician} is on the way!`;

        const interval = setInterval(() => {
            currentLat += (destinationLat - currentLat) * 0.04;
            currentLng += (destinationLng - currentLng) * 0.04;

            document.getElementById("map").src = 
                `https://www.google.com/maps?q=${currentLat},${currentLng}&z=16&output=embed`;

            const distance = Math.hypot(destinationLat - currentLat, destinationLng - currentLng);
            const minutes = Math.max(1, Math.round(distance * 111 * 10)); // rough km → mins

            document.getElementById("eta").textContent = `${minutes} mins away`;

            if (distance < 0.0015) {
                document.getElementById("status").textContent = `${booking.beautician} has arrived! ✨`;
                document.getElementById("eta").textContent = "At your door";
                clearInterval(interval);
            }
        }, 2800);
    }

    document.getElementById("startTracking").addEventListener("click", geocodeAndTrack);
}
</script>

</body>
</html>
